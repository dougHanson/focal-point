<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" type="text/css" href="styles.css" /> 
</head>


<body>

  <h1>Upload image and select the focal point:</h1><br>

  <input type="file" onchange="previewFile()"><br>


  <div class="image-wrapper">
    <!--<img src="image.jpg" class="uploaded" id="128397" />-->
    <img src="loading.gif" class="uploaded" />
    <div class="js-grid grid"></div>
    <div class="js-box grid-box"></div>
  </div>

  <h2>Change grid size:</h2>
  <input value="12" class="js-input" id="js-input" onChange="getGridSize()" maxlength="2" min=2 max="50" style="height:32px; width: 60px;" />
  <button for="js-input" onClick="getGridSize()" style="padding:5px 10px;">Update grid</button>
  <br><br>

  <!-- SAVE BTN -->
  <button onClick="saveImgMargins()" style="padding:15px 20px; background-color: lawngreen;">SAVE &amp; PUBLISH</button>
  <br><br>

  <!-- redraw btn -->
  <!--<button onClick="draw()" style="padding:15px 40px; background-color:indianred;">DRAW FROM FILE</button>
    <br><br>-->

  <p>last square clicked: <span class="test"></span></p>
  <p>SAVED focal point: <span class="test2"></span></p>
  <!--<p>drawing from: <span class="test2"></span></p>-->



  <h1>Output:</h1><br>

  <!-- various output image sizes - output class should be hidden with no-js -->
  <div class="output-wrapper">

    <!-- skyscraper -->
    <div class="output skyscraper">
      <img src="loading.gif" class="js-output" style="min-height: 100%;" />
    </div>
    
    <!-- hero -->
    <div class="output hero">
      <img src="loading.gif" class="js-output" />
    </div>    

    <!-- leaderboard -->
    <div class="output leaderboard">
      <img src="loading.gif" class="js-output" />
    </div>

    <!-- leaderboard short -->
    <div class="output leaderboard-short">
      <img src="loading.gif" class="js-output" style="width: 100%; " />
    </div>

    <!-- feature -->
    <div class="output feature">
      <img src="loading.gif" class="js-output" />
    </div>
    
    <!-- big rec -->
    <div class="output big-rec">
      <img src="loading.gif" class="js-output" style="" />
    </div>

    <!-- m rec -->
    <div class="output mrec">
      <img src="loading.gif" class="js-output" />
    </div>    

    
    <!-- thumbnail -->
    <div class="output thumbnail">
      <img src="loading.gif" class="js-output" />
    </div>

    <!-- tiny -->
    <div class="output tiny">
      <img src="loading.gif" class="js-output" style="min-height: 50px; max-height: 100px;" />
    </div> 

    
    <!-- simple no-js fallback -->
    <noscript>
      <h2>noscript fallback:</h2>
      <div class="output" style="width: 960px; height: 450px;">
        <img src="image.jpg" class="js-output" style="height: auto; max-width: 100%;" />
      </div>
    </noscript>

  </div>


  <script src="https://code.jquery.com/jquery-1.12.4.min.js" crossorigin="anonymous"></script>

  <script>

    // #DOUG - define image once here for testing

    var imgSrc = 'image@3x.jpg';
    //var imgSrc = 'couple@3x.jpg';
    var imgSrc = 'tree.jpg';
    //var imgSrc = 'hand.jpg';
    //var imgSrc = 'tree.jpg';            
    $('.js-output, .uploaded').attr('src', imgSrc);


    var gridSize = 12; //must be a SQUARE grid, eg 10 x 10
    var gridImg = $('.js-grid'); //the grid image will be placed on top of the uploaded image //#DOUG: make this CSS, not image
    var uploadImg = $('.uploaded'); //the uploaded image element
    var imgWidth = uploadImg.width(); //width of the uploaded image
    var imgHeight = uploadImg.height(); //height of uploaded image
    var squareWidth = imgWidth / gridSize; //how wide each square is on the grid is determined by image size
    var squareHeight = imgHeight / gridSize; //how tall each square is on the grid is determined by image size
    var squareClicked = [gridSize / 2, gridSize / 2]; //needs global scope for resize event, half gridsize = middle of pic by default
    var positionX = 0; //px margin that image will be pulled to the LEFT
    var positionY = 0; //px margin that image will be pulled to the TOP
    //var aspectRatio = imgWidth / imgHeight; //not needed?

    //object to save focal points in for each image
    var imgId = $('.uploaded').attr('src');
    var imgMargins = {
        "init": {
          "X": squareClicked[0],
          "Y": squareClicked[1]
        }
    };    

    
    //  SAVE()
    // save image focal point into local storage
    function saveImgMargins() {
      $('.js-box').css({ 'background-color': '#00ff00' });
      $('.js-box').html('saved');

      //add new focal points to existing object
      if ( imgId.length) {
        $.extend(imgMargins, { imgId: { "X": squareClicked[0], "Y": squareClicked[1], "grid": gridSize } });
        localStorage.setItem('imgMargins', JSON.stringify(imgMargins));
      }
      
      //get saved focal point for image
      var obj = JSON.parse(localStorage.getItem('imgMargins'));
      console.log(obj);
      $('.test2').html('' + obj[imgId].X + ' , ' + obj[imgId].Y);

    }


    //  LAYGRID()
    // overlay grid image - squash it to fit the image shape
    // this is called on doc load and window resize so it always fits image
    function layGrid() {
      $('.js-grid').html(''); //clear the grid to start

      imgWidth = uploadImg.width();
      imgHeight = uploadImg.height();

      squareWidth = imgWidth / gridSize; //how wide each square is on the grid is determined by image size
      squareHeight = imgHeight / gridSize;

      for (var i = 0; i < gridSize; i++) {
        for (var j = 0; j < gridSize; j++) {
          $('.js-grid').append("<div style='border-right: 1px solid #000; border-bottom: 1px solid #000; float: left; height:" + (squareHeight - 0.1) + "px; width:" + (squareWidth - 0.1) + "px;'>&nbsp;</div>"); // deduct part of pixel to ensure grid always smaller than image, even with borders
        }
        $('.js-grid').append("<div style='clear: both; '></div>"); //newline
      }

      $('.js-box').css({
        'top': 0,
        'left': 0,
        'opacity': 0
      }) // reset the box (not the selection)
    }

    
    //  GETGRIDSIZE()
    //get gridsize from entered input, then redraw grid
    var getGridSize = function() {
      gridSize = $('.js-input').val();
      layGrid();
    }

    
    //  CALCSQUARECLICKED()
    //when a square on the grid is clicked, get it's x and y offset within its bounding container
    //divide it by width of one square to return it as a multiple of grid squares, then
    //round that value to the nearest integer        
    function calcSquareClicked(e) {
      var offset = gridImg.offset();
      var scrollTop = $(window).scrollTop();

      squareWidth = imgWidth / gridSize; //how wide each square is on the grid is determined by image size
      squareHeight = imgHeight / gridSize;
      squareClicked = []; // gotta reset this so values are cleared b4 new values pushed
      var squaresX = (e.clientX / squareWidth) - offset.left;
      var squaresXInt = parseInt(squaresX);

      var squaresY = (e.clientY + scrollTop - offset.top) / squareHeight;
      var squaresYInt = parseInt(squaresY);

      // push x and y square into array
      squareClicked.push(squaresXInt, squaresYInt);

      //draw a box the size of one square to show which area was clicked, using value from above calc
      $('.js-box').css({
        'height': squareHeight,
        'width': squareWidth,
        'top': parseInt(squaresY) * squareHeight,
        'left': parseInt(squaresX) * squareWidth,
        'opacity': 0.66
      });

      //return (squareClicked);

    }

    
    // CALCMARGINS()
    // calculate margins based on wrapping container dimensions
    function calcMargins(focal) {
      // if we're passing a saved focal point through, use that instead
      if (focal != undefined) {
        squareClicked[0] = focal.X;
        squareClicked[1] = focal.Y;
      }

      //for each output image, get the container height and width and calc margins
      $('.js-output').each(function() {
        var outputContainerWidth = $(this).parent().width();
        var outputContainerHeight = $(this).parent().height();

        //how many px we have to pull the image
        var playX = $(this).width() - outputContainerWidth;
        var playY = $(this).height() - outputContainerHeight;

        //how much we move the image is the number of squares as a % of play
        //For example, if we have a 900px image and a 300px container, the play will be
        //900px - 300px = 600px play. If the grid has 12 squares, moving it one square
        //will pull image 1/12 * 600px = 50px. Moving it 12 squares will move it 12/12 * 600px = 600px
        positionX = (((squareClicked[0]) * (1 / (gridSize - 1))) * playX); //parentheses and gridSize-1 are CRITICAL here
        positionY = (((squareClicked[1]) * (1 / (gridSize - 1))) * playY); //i guess this func would be needed every page, squareClicked[] would be server side var 4 each img id

        //prob not needed, just ensures img never goes beyond boundaries
        if (positionX > playX) {
          positionX = playX;
        }
        if (positionY > playY) {
          positionY = playY;
        }

        //these are basically the values that will need to be calculated and applied to each image on page load & resize
        $(this).css({
          'margin-left': -positionX,
          'margin-top': -positionY
        });
      });

    }


    //  PREVIEWFILE()
    // gets file from hdd and uploads into container
    function previewFile() {
      var preview = document.querySelector('img'); //selects the query named img
      var file = document.querySelector('input[type=file]').files[0]; //sames as here
      var reader = new FileReader();

      reader.onloadend = function() {
        preview.src = reader.result;
      }

      if (file) {
        reader.readAsDataURL(file); //reads the data as a URL
      } else {
        preview.src = "";
      }

      imgSrc = preview.src;
      
      //set small delay to ensure images have resized before recalc of margins
      setTimeout(function() {
        layGrid();
        $('.js-output, .uploaded').attr('src', preview.src);
        var obj = JSON.parse(localStorage.getItem('imgMargins'));
        calcMargins(obj[imgId]);
        // calcMargins();
      }, 250);
    }
    
    
    //  when a focal point is clicked 
    gridImg.on('click', function(e) {

      $('.js-box').css({
        'background-color': '#ff0000'
      });
      $('.js-box').html('unsaved');

      //get which square user clicked on
      calcSquareClicked(e);
      
      $('.test').html(' ' + squareClicked[0] + ' , ' + squareClicked[1]);
      
      //then calc margins and apply them
      calcMargins();

    }); // end onClick


    
    //previewFile();  //calls the function named previewFile()      

  
    //on doc load and window resize, refit the grid and
    //recalc the margins based on new container width
    //needs fallback for no-js!?
    $(window).on("load resize", function(e) {
      layGrid();
      
      if (imgMargins.length) {
        var obj = JSON.parse(localStorage.getItem('imgMargins'));
        if (obj.hasOwnProperty(imgId)) {
          $('.test2').html('' + obj[imgId].X + ' , ' + obj[imgId].Y);
                console.log(obj);
      
      setTimeout(function() { //set small delay to ensure images have resized before recalc of margins
        calcMargins(obj[imgId]);
        //calcMargins();
      }, 100);
        }
      }
      



    });
  </script>


</body>

</html>